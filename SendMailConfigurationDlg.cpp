// SendMailConfigurationDlg.cpp : implementation file
//

#include "stdafx.h"
#include "uimager.h"
#include "Helpers.h"
#include "VideoDeviceDoc.h"
#include "SendMailConfigurationDlg.h"

#ifdef _DEBUG
#define new DEBUG_NEW
#undef THIS_FILE
static char THIS_FILE[] = __FILE__;
#endif

#ifdef VIDEODEVICEDOC

/////////////////////////////////////////////////////////////////////////////
// CSendMailConfigurationDlg dialog

CSendMailConfigurationDlg::CSendMailConfigurationDlg(CVideoDeviceDoc* pDoc)
	: CDialog(CSendMailConfigurationDlg::IDD, NULL)
{
	//{{AFX_DATA_INIT(CSendMailConfigurationDlg)
		// NOTE: the ClassWizard will add member initialization here
	//}}AFX_DATA_INIT
	ASSERT_VALID(pDoc);
	m_pDoc = pDoc;
	m_SendMailConfiguration = pDoc->m_MovDetSendMailConfiguration;
}

void CSendMailConfigurationDlg::DoDataExchange(CDataExchange* pDX)
{
	CDialog::DoDataExchange(pDX);
	//{{AFX_DATA_MAP(CSendMailConfigurationDlg)
		// NOTE: the ClassWizard will add DDX and DDV calls here
	//}}AFX_DATA_MAP
}

BEGIN_MESSAGE_MAP(CSendMailConfigurationDlg, CDialog)
	//{{AFX_MSG_MAP(CSendMailConfigurationDlg)
	ON_BN_CLICKED(IDC_BUTTON_TEST, OnButtonTest)
	ON_CBN_SELCHANGE(IDC_AUTH_METHOD, OnSelchangeAuthMethod)
	//}}AFX_MSG_MAP
END_MESSAGE_MAP()

/////////////////////////////////////////////////////////////////////////////
// CSendMailConfigurationDlg message handlers

BOOL CSendMailConfigurationDlg::OnInitDialog() 
{
	CDialog::OnInitDialog();

	// To Email
	CEdit* pEdit = (CEdit*)GetDlgItem(IDC_RECEIVER_MAIL);
	pEdit->SetWindowText(m_SendMailConfiguration.m_sTo);

	// Send HTML Email?
	CButton* pCheck = (CButton*)GetDlgItem(IDC_HTML);
	pCheck->SetCheck(m_SendMailConfiguration.m_bHTML ? 1 : 0);

	// Attachment possibilities
	CComboBox* pComboBox = (CComboBox*)GetDlgItem(IDC_ATTACHMENT);
    pComboBox->AddString(_T("None"));
    pComboBox->AddString(_T("AVI"));
    pComboBox->AddString(_T("GIF"));
    pComboBox->AddString(_T("JPG"));
	pComboBox->AddString(_T("GIF + AVI"));
	pComboBox->AddString(_T("JPG + AVI"));
	pComboBox->AddString(_T("GIF + JPG"));
	pComboBox->AddString(_T("GIF + JPG + AVI"));
	pComboBox->SetCurSel((int)m_SendMailConfiguration.m_AttachmentType);

	// From Name
	pEdit = (CEdit*)GetDlgItem(IDC_SENDER_NAME);
	pEdit->SetWindowText(m_SendMailConfiguration.m_sFromName);

	// From Email
	pEdit = (CEdit*)GetDlgItem(IDC_SENDER_MAIL);
	pEdit->SetWindowText(m_SendMailConfiguration.m_sFrom);

	// Subject Line
	pEdit = (CEdit*)GetDlgItem(IDC_SUBJECT_LINE);
	pEdit->SetWindowText(m_SendMailConfiguration.m_sSubject);

	// Server Name
	pEdit = (CEdit*)GetDlgItem(IDC_HOST_NAME);
	pEdit->SetWindowText(m_SendMailConfiguration.m_sHost);

	// Server Port
	pEdit = (CEdit*)GetDlgItem(IDC_HOST_PORT);
	CString sPort;
	sPort.Format(_T("%i"), m_SendMailConfiguration.m_nPort);
	pEdit->SetWindowText(sPort);

	// Auth Methods
    int index = 0;
	BOOL bAuthenticated = (m_SendMailConfiguration.m_Auth != CPJNSMTPConnection::AUTH_NONE);
	pComboBox = (CComboBox*)GetDlgItem(IDC_AUTH_METHOD);
	pComboBox->AddString(ML_STRING(1827, "None"));		// CPJNSMTPConnection::AUTH_NONE = 0
														// use no authentication with the server
	pComboBox->SetItemData(index++, CPJNSMTPConnection::AUTH_NONE);
    pComboBox->AddString(ML_STRING(1828, "CRAM MD5"));	// CPJNSMTPConnection::AUTH_CRAM_MD5 = 1
														// CRAM (Challenge Response Authention Method) MD5 (RFC 2195).
														// A challenge is generated by the server, and the response is
														// the MD5 HMAC of the challenge using the password as the key.
														// The username is also supplied in the challenge response.
	pComboBox->SetItemData(index++, CPJNSMTPConnection::AUTH_CRAM_MD5);
    pComboBox->AddString(ML_STRING(1829, "AUTH LOGIN"));// CPJNSMTPConnection::AUTH_LOGIN = 2
														// username and password are simply base64 encoded responses to the server
	pComboBox->SetItemData(index++, CPJNSMTPConnection::AUTH_LOGIN);
    pComboBox->AddString(ML_STRING(1830, "AUTH PLAIN"));// CPJNSMTPConnection::AUTH_PLAIN = 3
														// username and password are sent in the clear to the server
	pComboBox->SetItemData(index++, CPJNSMTPConnection::AUTH_PLAIN);
    pComboBox->AddString(ML_STRING(1831, "NTLM"));		// CPJNSMTPConnection::AUTH_NTLM = 4
														// use the MS NTLM authentication protocol
	pComboBox->SetItemData(index++, CPJNSMTPConnection::AUTH_NTLM);
	pComboBox->AddString(ML_STRING(1832, "Auto Detect"));// CPJNSMTPConnection::AUTH_AUTO = 5
														// try to auto negotiate the authentication protocol to use,
														// the order used will be as decided by the "ChooseAuthenticationMethod"
														// virtual method
	pComboBox->SetItemData(index++, CPJNSMTPConnection::AUTH_AUTO);
	for (index = 0 ; index < pComboBox->GetCount() ; index++)
	{
		if (pComboBox->GetItemData(index) == m_SendMailConfiguration.m_Auth)
		{
			pComboBox->SetCurSel(index);
			break;
		}
	}

	// Username and Password
	pEdit = (CEdit*)GetDlgItem(IDC_AUTH_USERNAME);
	pEdit->SetWindowText(m_SendMailConfiguration.m_sUsername);
	pEdit->EnableWindow(bAuthenticated);
	pEdit = (CEdit*)GetDlgItem(IDC_AUTH_PASSWORD);
	pEdit->SetWindowText(m_SendMailConfiguration.m_sPassword);
	pEdit->EnableWindow(bAuthenticated);

	// Connection Type
	pComboBox = (CComboBox*)GetDlgItem(IDC_CONNECTIONTYPE);
	pComboBox->AddString(ML_STRING(1833, "Plain Text (Port 25 or 587)"));
#ifndef CPJNSMTP_NOSSL
    pComboBox->AddString(ML_STRING(1834, "SSL/TLS (Port 465)"));	
    pComboBox->AddString(ML_STRING(1835, "STARTTLS (Port 25 or 587)"));
	pComboBox->SetCurSel(m_SendMailConfiguration.m_ConnectionType);
#else
	pComboBox->SetCurSel(0);
	pComboBox->EnableWindow(FALSE);
#endif

	return TRUE;  // return TRUE unless you set the focus to a control
	              // EXCEPTION: OCX Property Pages should return FALSE
}

void CSendMailConfigurationDlg::OnSelchangeAuthMethod() 
{
	CComboBox* pComboBox = (CComboBox*)GetDlgItem(IDC_AUTH_METHOD);
	CPJNSMTPConnection::AuthenticationMethod Authentication =
				(CPJNSMTPConnection::AuthenticationMethod)pComboBox->GetItemData(pComboBox->GetCurSel());
	BOOL bAuthenticated = (Authentication != CPJNSMTPConnection::AUTH_NONE);
	CEdit* pEdit = (CEdit*)GetDlgItem(IDC_AUTH_USERNAME);
	pEdit->EnableWindow(bAuthenticated);
	pEdit = (CEdit*)GetDlgItem(IDC_AUTH_PASSWORD);
	pEdit->EnableWindow(bAuthenticated);
}

void CSendMailConfigurationDlg::CopyToStruct()
{
	CString sText;

	CEdit* pEdit = (CEdit*)GetDlgItem(IDC_RECEIVER_MAIL);
	pEdit->GetWindowText(sText);
	m_SendMailConfiguration.m_sTo = sText;

	CButton* pCheck = (CButton*)GetDlgItem(IDC_HTML);
	m_SendMailConfiguration.m_bHTML = pCheck->GetCheck();

	CComboBox* pComboBox = (CComboBox*)GetDlgItem(IDC_ATTACHMENT);
	m_SendMailConfiguration.m_AttachmentType =
			(CVideoDeviceDoc::AttachmentType)pComboBox->GetCurSel();

	pEdit = (CEdit*)GetDlgItem(IDC_SENDER_NAME);
	pEdit->GetWindowText(sText);
	m_SendMailConfiguration.m_sFromName = sText;

	pEdit = (CEdit*)GetDlgItem(IDC_SENDER_MAIL);
	pEdit->GetWindowText(sText);
	m_SendMailConfiguration.m_sFrom = sText;

	pEdit = (CEdit*)GetDlgItem(IDC_SUBJECT_LINE);
	pEdit->GetWindowText(sText);
	m_SendMailConfiguration.m_sSubject = sText;

	pEdit = (CEdit*)GetDlgItem(IDC_HOST_NAME);
	pEdit->GetWindowText(sText);
	m_SendMailConfiguration.m_sHost = sText;

	pEdit = (CEdit*)GetDlgItem(IDC_HOST_PORT);
	pEdit->GetWindowText(sText);
	int nPort = _tcstol(sText.GetBuffer(0), NULL, 10);
	sText.ReleaseBuffer();
	if (nPort > 0 && nPort <= 65535) // Port 0 is Reserved
		m_SendMailConfiguration.m_nPort = nPort;
	else
		m_SendMailConfiguration.m_nPort = 25;

	pComboBox = (CComboBox*)GetDlgItem(IDC_AUTH_METHOD);
	m_SendMailConfiguration.m_Auth =
			(CPJNSMTPConnection::AuthenticationMethod)pComboBox->GetItemData(pComboBox->GetCurSel());

	pEdit = (CEdit*)GetDlgItem(IDC_AUTH_USERNAME);
	pEdit->GetWindowText(sText);
	m_SendMailConfiguration.m_sUsername = sText;

	pEdit = (CEdit*)GetDlgItem(IDC_AUTH_PASSWORD);
	pEdit->GetWindowText(sText);
	m_SendMailConfiguration.m_sPassword = sText;

	pComboBox = (CComboBox*)GetDlgItem(IDC_CONNECTIONTYPE);
	m_SendMailConfiguration.m_ConnectionType =
			(CPJNSMTPConnection::ConnectionType)pComboBox->GetCurSel();
}

void CSendMailConfigurationDlg::OnOK() 
{
	CopyToStruct();
	m_pDoc->m_MovDetSendMailConfiguration = m_SendMailConfiguration;
	CDialog::OnOK();
}

void CSendMailConfigurationDlg::OnButtonTest() 
{
	CopyToStruct();

	if (m_SendMailConfiguration.m_sHost.IsEmpty()	||
		m_SendMailConfiguration.m_sFrom.IsEmpty()	||
		m_SendMailConfiguration.m_sTo.IsEmpty()) 
		::AfxMessageBox(ML_STRING(1406, "Please Enter A Host Name, a From and a To Address"));
	else 
	{
		BeginWaitCursor();

		CPJNSMTPMessage* pMessage = NULL;
		try
		{
			if (m_SendMailConfiguration.m_bHTML == FALSE)
			{
				m_SendMailConfiguration.m_bMime = FALSE;
				m_SendMailConfiguration.m_sBody = m_pDoc->GetAssignedDeviceName();

				// No Attachment(s)
				m_SendMailConfiguration.m_sFiles = _T("");

				// Create the message
				pMessage = m_pDoc->CreateEmailMessage(CTime::GetCurrentTime(), &m_SendMailConfiguration);
			}
			else
			{
				m_SendMailConfiguration.m_bMime = TRUE;
				m_SendMailConfiguration.m_sFiles = _T("");
				m_SendMailConfiguration.m_sBody = _T("");

				// Create the message
				pMessage = m_pDoc->CreateEmailMessage(CTime::GetCurrentTime(), &m_SendMailConfiguration);

				for (int i = 0 ; i < pMessage->GetNumberOfBodyParts() ; i++)
					pMessage->RemoveBodyPart(i);

				// Setup all the body parts we want
				CPJNSMTPBodyPart related;
				related.SetContentType(_T("multipart/related"));
				related.SetCharset(pMessage->GetCharset());

				CPJNSMTPBodyPart html;
				html.SetText(_T("<p>") + ::HtmlEncode(m_pDoc->GetAssignedDeviceName()) + _T("</p>"));
				html.SetContentType(_T("text/html"));
				html.SetCharset(pMessage->GetCharset());

				related.AddChildBodyPart(html);
				pMessage->AddBodyPart(related);
				pMessage->GetBodyPart(0)->SetContentLocation(_T("http://localhost"));
			}

			// Init Connection class
			CPJNSMTPConnection connection;

			CString sHost;
			BOOL bSend = TRUE;
			if (m_SendMailConfiguration.m_bDNSLookup)
			{
				if (pMessage->m_To.GetSize() == 0)
				{
					EndWaitCursor();
					CString sMsg(ML_STRING(1410, "At least one recipient must be specified to use the DNS lookup option\n"));
					TRACE(sMsg);
					::AfxMessageBox(sMsg);
					bSend = FALSE;
				}
				else
				{
					CString sAddress(pMessage->m_To.ElementAt(0).m_sEmailAddress);
					int nAmpersand = sAddress.Find(_T("@"));
					if (nAmpersand == -1)
					{
						EndWaitCursor();
						CString sMsg;
						sMsg.Format(ML_STRING(1411, "Unable to determine the domain for the email address %s\n"), sAddress);
						TRACE(sMsg);
						::AfxMessageBox(sMsg);
						bSend = FALSE;
					}
					else
					{
						// We just pick the first MX record found, other implementations could ask the user
						// or automatically pick the lowest priority record
						CString sDomain(sAddress.Right(sAddress.GetLength() - nAmpersand - 1));
						CStringArray servers;
						CWordArray priorities;
						if (!connection.MXLookup(sDomain, servers, priorities))
						{
							EndWaitCursor();
							CString sMsg;
							sMsg.Format(ML_STRING(1413, "Unable to perform a DNS MX lookup for the domain %s, Error Code:%d\n"), sDomain, GetLastError());
							TRACE(sMsg);
							::AfxMessageBox(sMsg);
							bSend = FALSE;
						}
						else
							sHost = servers.GetAt(0);
					}
				}
			}
			else
				sHost = m_SendMailConfiguration.m_sHost;

			// Connect and send the message
			if (bSend)
			{
				connection.SetBindAddress(m_SendMailConfiguration.m_sBoundIP);
				if (m_SendMailConfiguration.m_sUsername == _T("") &&
					m_SendMailConfiguration.m_sPassword == _T(""))
				{
					connection.Connect(	sHost,
										CPJNSMTPConnection::AUTH_NONE,
										m_SendMailConfiguration.m_sUsername,
										m_SendMailConfiguration.m_sPassword,
										m_SendMailConfiguration.m_nPort
#ifndef CPJNSMTP_NOSSL
										, m_SendMailConfiguration.m_ConnectionType
#endif
										);
				}
				else
				{
					connection.Connect(	sHost,
										m_SendMailConfiguration.m_Auth,
										m_SendMailConfiguration.m_sUsername,
										m_SendMailConfiguration.m_sPassword,
										m_SendMailConfiguration.m_nPort
#ifndef CPJNSMTP_NOSSL
										, m_SendMailConfiguration.m_ConnectionType
#endif
										);
				}
				connection.SendMessage(*pMessage);
				EndWaitCursor();
				::AfxMessageBox(ML_STRING(1409, "Success: Email Sent."), MB_ICONINFORMATION);
			}

			// Clean-up
			if (pMessage)
				delete pMessage;
		}
		catch (CPJNSMTPException* pEx)
		{
			// Clean-up
			if (pMessage)
				delete pMessage;

			// Display the error
			EndWaitCursor();
			CString sMsg;
			sMsg.Format(ML_STRING(1414, "An error occured sending the message, Error:%x\nDescription:%s\n"),
						pEx->m_hr,
						pEx->GetErrorMessage());
			TRACE(sMsg);
			::AfxMessageBox(sMsg, MB_ICONSTOP);
			pEx->Delete();
		}
	}
}

#endif
