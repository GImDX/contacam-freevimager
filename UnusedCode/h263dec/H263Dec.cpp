#include "stdafx.h"
#include "H263Dec.h"
#include "Dib.h"

const int CH263Dec::m_bscan_tab[] = {2,4,6,8};
const int CH263Dec::m_bquant_tab[] = {5,6,7,8};
const int CH263Dec::m_roundtab[16] = {0,0,0,1,1,1,1,1,1,1,1,1,1,1,2,2};

// zig-zag scan 
const unsigned char CH263Dec::m_zig_zag_scan[64] =
{
	0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,
	12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,
	35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,
	58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63
};

// Color space conversion coefficients
// *
// * entries are {crv,cbu,cgu,cgv}
// *
// * crv=(255/224)*65536*(1-cr)/0.5
// * cbu=(255/224)*65536*(1-cb)/0.5
// * cgu=(255/224)*65536*(cb/cg)*(1-cb)/0.5
// * cgv=(255/224)*65536*(cr/cg)*(1-cr)/0.5
// *
// * where Y=cr*R+cg*G+cb*B (cr+cg+cb=1)
const int CH263Dec::m_convmat[8][4] =
{
	{117504, 138453, 13954, 34903}, //* no sequence_display_extension 
	{117504, 138453, 13954, 34903}, //* ITU-R Rec. 709 (1990) 
	{104597, 132201, 25675, 53279}, //* unspecified 
	{104597, 132201, 25675, 53279}, //* reserved 
	{104448, 132798, 24759, 53109}, //* FCC 
	{104597, 132201, 25675, 53279}, //* ITU-R Rec. 624-4 System B, G 
	{104597, 132201, 25675, 53279}, //* SMPTE 170M 
	{117579, 136230, 16907, 35559}  //* SMPTE 240M (1987) 
};

const int CH263Dec::m_OM[5][8][8]= 
{
	{
		{4,5,5,5,5,5,5,4},
		{5,5,5,5,5,5,5,5},
		{5,5,6,6,6,6,5,5},
		{5,5,6,6,6,6,5,5},
		{5,5,6,6,6,6,5,5},
		{5,5,6,6,6,6,5,5},
		{5,5,5,5,5,5,5,5},
		{4,5,5,5,5,5,5,4},
	},
	{
		{2,2,2,2,2,2,2,2},
		{1,1,2,2,2,2,1,1},
		{1,1,1,1,1,1,1,1},
		{1,1,1,1,1,1,1,1},
		{0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0},
	},
	{
		{0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0},
		{0,0,0,0,0,0,0,0},
		{1,1,1,1,1,1,1,1},
		{1,1,1,1,1,1,1,1},
		{1,1,2,2,2,2,1,1},
		{2,2,2,2,2,2,2,2},
	},
	{
		{0,0,0,0,1,1,1,2},
		{0,0,0,0,1,1,2,2},
		{0,0,0,0,1,1,2,2},
		{0,0,0,0,1,1,2,2},
		{0,0,0,0,1,1,2,2},
		{0,0,0,0,1,1,2,2},
		{0,0,0,0,1,1,2,2},
		{0,0,0,0,1,1,1,2},
	},
	{
		{2,1,1,1,0,0,0,0},
		{2,2,1,1,0,0,0,0},
		{2,2,1,1,0,0,0,0},
		{2,2,1,1,0,0,0,0},
		{2,2,1,1,0,0,0,0},
		{2,2,1,1,0,0,0,0},
		{2,2,1,1,0,0,0,0},
		{2,1,1,1,0,0,0,0},
	}
};

const CH263Dec::VLCtabI CH263Dec::m_DCT3Dtab0[] =
{
	{4225,7}, {4209,7}, {4193,7}, {4177,7}, {193,7}, {177,7}, 
	{161,7}, {4,7}, {4161,6}, {4161,6}, {4145,6}, {4145,6}, 
	{4129,6}, {4129,6}, {4113,6}, {4113,6}, {145,6}, {145,6}, 
	{129,6}, {129,6}, {113,6}, {113,6}, {97,6}, {97,6}, 
	{18,6}, {18,6}, {3,6}, {3,6}, {81,5}, {81,5}, 
	{81,5}, {81,5}, {65,5}, {65,5}, {65,5}, {65,5}, 
	{49,5}, {49,5}, {49,5}, {49,5}, {4097,4}, {4097,4}, 
	{4097,4}, {4097,4}, {4097,4}, {4097,4}, {4097,4}, {4097,4}, 
	{1,2}, {1,2}, {1,2}, {1,2}, {1,2}, {1,2}, 
	{1,2}, {1,2}, {1,2}, {1,2}, {1,2}, {1,2}, 
	{1,2}, {1,2}, {1,2}, {1,2}, {1,2}, {1,2}, 
	{1,2}, {1,2}, {1,2}, {1,2}, {1,2}, {1,2}, 
	{1,2}, {1,2}, {1,2}, {1,2}, {1,2}, {1,2}, 
	{1,2}, {1,2}, {17,3}, {17,3}, {17,3}, {17,3}, 
	{17,3}, {17,3}, {17,3}, {17,3}, {17,3}, {17,3}, 
	{17,3}, {17,3}, {17,3}, {17,3}, {17,3}, {17,3}, 
	{33,4}, {33,4}, {33,4}, {33,4}, {33,4}, {33,4}, 
	{33,4}, {33,4}, {2,4}, {2,4},{2,4},{2,4},
	{2,4}, {2,4},{2,4},{2,4}
};

const CH263Dec::VLCtabI CH263Dec::m_DCT3Dtab1[] =
{
	{9,10}, {8,10}, {4481,9}, {4481,9}, {4465,9}, {4465,9}, 
	{4449,9}, {4449,9}, {4433,9}, {4433,9}, {4417,9}, {4417,9}, 
	{4401,9}, {4401,9}, {4385,9}, {4385,9}, {4369,9}, {4369,9}, 
	{4098,9}, {4098,9}, {353,9}, {353,9}, {337,9}, {337,9}, 
	{321,9}, {321,9}, {305,9}, {305,9}, {289,9}, {289,9}, 
	{273,9}, {273,9}, {257,9}, {257,9}, {241,9}, {241,9}, 
	{66,9}, {66,9}, {50,9}, {50,9}, {7,9}, {7,9}, 
	{6,9}, {6,9}, {4353,8}, {4353,8}, {4353,8}, {4353,8}, 
	{4337,8}, {4337,8}, {4337,8}, {4337,8}, {4321,8}, {4321,8}, 
	{4321,8}, {4321,8}, {4305,8}, {4305,8}, {4305,8}, {4305,8}, 
	{4289,8}, {4289,8}, {4289,8}, {4289,8}, {4273,8}, {4273,8}, 
	{4273,8}, {4273,8}, {4257,8}, {4257,8}, {4257,8}, {4257,8}, 
	{4241,8}, {4241,8}, {4241,8}, {4241,8}, {225,8}, {225,8}, 
	{225,8}, {225,8}, {209,8}, {209,8}, {209,8}, {209,8}, 
	{34,8}, {34,8}, {34,8}, {34,8}, {19,8}, {19,8}, 
	{19,8}, {19,8}, {5,8}, {5,8}, {5,8}, {5,8}
};

const CH263Dec::VLCtabI CH263Dec::m_DCT3Dtab2[] =
{
	{4114,11}, {4114,11}, {4099,11}, {4099,11}, {11,11}, {11,11}, 
	{10,11}, {10,11}, {4545,10}, {4545,10}, {4545,10}, {4545,10}, 
	{4529,10}, {4529,10}, {4529,10}, {4529,10}, {4513,10}, {4513,10}, 
	{4513,10}, {4513,10}, {4497,10}, {4497,10}, {4497,10}, {4497,10}, 
	{146,10}, {146,10}, {146,10}, {146,10}, {130,10}, {130,10}, 
	{130,10}, {130,10}, {114,10}, {114,10}, {114,10}, {114,10}, 
	{98,10}, {98,10}, {98,10}, {98,10}, {82,10}, {82,10}, 
	{82,10}, {82,10}, {51,10}, {51,10}, {51,10}, {51,10}, 
	{35,10}, {35,10}, {35,10}, {35,10}, {20,10}, {20,10}, 
	{20,10}, {20,10}, {12,11}, {12,11}, {21,11}, {21,11}, 
	{369,11}, {369,11}, {385,11}, {385,11}, {4561,11}, {4561,11}, 
	{4577,11}, {4577,11}, {4593,11}, {4593,11}, {4609,11}, {4609,11}, 
	{22,12}, {36,12}, {67,12}, {83,12}, {99,12}, {162,12}, 
	{401,12}, {417,12}, {4625,12}, {4641,12}, {4657,12}, {4673,12}, 
	{4689,12}, {4705,12}, {4721,12}, {4737,12}, {7167,7}, 
	{7167,7}, {7167,7}, {7167,7}, {7167,7}, {7167,7}, {7167,7}, 
	{7167,7}, {7167,7}, {7167,7}, {7167,7}, {7167,7}, {7167,7}, 
	{7167,7}, {7167,7}, {7167,7}, {7167,7}, {7167,7}, {7167,7}, 
	{7167,7}, {7167,7}, {7167,7}, {7167,7}, {7167,7}, {7167,7}, 
	{7167,7}, {7167,7}, {7167,7}, {7167,7}, {7167,7}, {7167,7}, 
	{7167,7}
};

/* to mask the n least significant bits of an integer */
const unsigned int CH263Dec::m_msk[33] =
{
	0x00000000,0x00000001,0x00000003,0x00000007,
	0x0000000f,0x0000001f,0x0000003f,0x0000007f,
	0x000000ff,0x000001ff,0x000003ff,0x000007ff,
	0x00000fff,0x00001fff,0x00003fff,0x00007fff,
	0x0000ffff,0x0001ffff,0x0003ffff,0x0007ffff,
	0x000fffff,0x001fffff,0x003fffff,0x007fffff,
	0x00ffffff,0x01ffffff,0x03ffffff,0x07ffffff,
	0x0fffffff,0x1fffffff,0x3fffffff,0x7fffffff,
	0xffffffff
};

const CH263Dec::VLCtab CH263Dec::m_TMNMVtab0[] =
{
	{3,4}, {61,4}, {2,3}, {2,3}, {62,3}, {62,3}, 
	{1,2}, {1,2}, {1,2}, {1,2}, {63,2}, {63,2}, {63,2}, {63,2}
};

const CH263Dec::VLCtab CH263Dec::m_TMNMVtab1[] =
{
	{12,10}, {52,10}, {11,10}, {53,10}, {10,9}, {10,9}, 
	{54,9}, {54,9}, {9,9}, {9,9}, {55,9}, {55,9}, 
	{8,9}, {8,9}, {56,9}, {56,9}, {7,7}, {7,7}, 
	{7,7}, {7,7}, {7,7}, {7,7}, {7,7}, {7,7}, 
	{57,7}, {57,7}, {57,7}, {57,7}, {57,7}, {57,7}, 
	{57,7}, {57,7}, {6,7}, {6,7}, {6,7}, {6,7}, 
	{6,7}, {6,7}, {6,7}, {6,7}, {58,7}, {58,7}, 
	{58,7}, {58,7}, {58,7}, {58,7}, {58,7}, {58,7}, 
	{5,7}, {5,7}, {5,7}, {5,7}, {5,7}, {5,7}, 
	{5,7}, {5,7}, {59,7}, {59,7}, {59,7}, {59,7}, 
	{59,7}, {59,7}, {59,7}, {59,7}, {4,6}, {4,6}, 
	{4,6}, {4,6}, {4,6}, {4,6}, {4,6}, {4,6}, 
	{4,6}, {4,6}, {4,6}, {4,6}, {4,6}, {4,6}, 
	{4,6}, {4,6}, {60,6}, {60,6},{60,6},{60,6},
	{60,6},{60,6},{60,6},{60,6},{60,6},{60,6},
	{60,6},{60,6},{60,6},{60,6},{60,6},{60,6}
};

const CH263Dec::VLCtab CH263Dec::m_TMNMVtab2[] =
{
	{32,12}, {31,12}, {33,12}, {30,11}, {30,11}, {34,11}, 
	{34,11}, {29,11}, {29,11}, {35,11}, {35,11}, {28,11}, 
	{28,11}, {36,11}, {36,11}, {27,11}, {27,11}, {37,11}, 
	{37,11}, {26,11}, {26,11}, {38,11}, {38,11}, {25,11}, 
	{25,11}, {39,11}, {39,11}, {24,10}, {24,10}, {24,10}, 
	{24,10}, {40,10}, {40,10}, {40,10}, {40,10}, {23,10}, 
	{23,10}, {23,10}, {23,10}, {41,10}, {41,10}, {41,10}, 
	{41,10}, {22,10}, {22,10}, {22,10}, {22,10}, {42,10}, 
	{42,10}, {42,10}, {42,10}, {21,10}, {21,10}, {21,10}, 
	{21,10}, {43,10}, {43,10}, {43,10}, {43,10}, {20,10}, 
	{20,10}, {20,10}, {20,10}, {44,10}, {44,10}, {44,10}, 
	{44,10}, {19,10}, {19,10}, {19,10}, {19,10}, {45,10}, 
	{45,10}, {45,10}, {45,10}, {18,10}, {18,10}, {18,10}, 
	{18,10}, {46,10}, {46,10}, {46,10}, {46,10}, {17,10}, 
	{17,10}, {17,10}, {17,10}, {47,10}, {47,10}, {47,10}, 
	{47,10}, {16,10}, {16,10}, {16,10}, {16,10}, {48,10}, 
	{48,10}, {48,10}, {48,10}, {15,10}, {15,10}, {15,10}, 
	{15,10}, {49,10}, {49,10}, {49,10}, {49,10}, {14,10}, 
	{14,10}, {14,10}, {14,10}, {50,10}, {50,10}, {50,10}, 
	{50,10}, {13,10}, {13,10}, {13,10}, {13,10}, {51,10}, 
	{51,10}, {51,10}, {51,10}
};

const CH263Dec::VLCtab CH263Dec::m_MCBPCtab[] =
{
	{-1,0},
	{255,9}, {52,9}, {36,9}, {20,9}, {49,9}, {35,8}, {35,8}, {19,8}, {19,8}, 
	{50,8}, {50,8}, {51,7}, {51,7}, {51,7}, {51,7}, {34,7}, {34,7}, {34,7}, 
	{34,7}, {18,7}, {18,7}, {18,7}, {18,7}, {33,7}, {33,7}, {33,7}, {33,7}, 
	{17,7}, {17,7}, {17,7}, {17,7}, {4,6}, {4,6}, {4,6}, {4,6}, {4,6}, 
	{4,6}, {4,6}, {4,6}, {48,6}, {48,6}, {48,6}, {48,6}, {48,6}, {48,6}, 
	{48,6}, {48,6}, {3,5}, {3,5}, {3,5}, {3,5}, {3,5}, {3,5}, {3,5}, 
	{3,5}, {3,5}, {3,5}, {3,5}, {3,5}, {3,5}, {3,5}, {3,5}, {3,5}, 
	{32,4}, {32,4}, {32,4}, {32,4}, {32,4}, {32,4}, {32,4}, {32,4}, {32,4}, 
	{32,4}, {32,4}, {32,4}, {32,4}, {32,4}, {32,4}, {32,4}, {32,4}, {32,4}, 
	{32,4}, {32,4}, {32,4}, {32,4}, {32,4}, {32,4}, {32,4}, {32,4}, {32,4}, 
	{32,4}, {32,4}, {32,4}, {32,4}, {32,4}, {16,4}, {16,4}, {16,4}, {16,4}, 
	{16,4}, {16,4}, {16,4}, {16,4}, {16,4}, {16,4}, {16,4}, {16,4}, {16,4}, 
	{16,4}, {16,4}, {16,4}, {16,4}, {16,4}, {16,4}, {16,4}, {16,4}, {16,4}, 
	{16,4}, {16,4}, {16,4}, {16,4}, {16,4}, {16,4}, {16,4}, {16,4}, {16,4}, 
	{16,4}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, 
	{2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, 
	{2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, 
	{2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, 
	{2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, 
	{2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, 
	{2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, {2,3}, 
	{2,3}, {2,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, 
	{1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, 
	{1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, 
	{1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, 
	{1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, 
	{1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, 
	{1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, {1,3}, 
	{1,3}, {1,3}, {1,3}, 
};

const CH263Dec::VLCtab CH263Dec::m_MCBPCtabintra[] =
{
	{-1,0},
	{20,6}, {36,6}, {52,6}, {4,4}, {4,4}, {4,4}, 
	{4,4}, {19,3}, {19,3}, {19,3}, {19,3}, {19,3}, 
	{19,3}, {19,3}, {19,3}, {35,3}, {35,3}, {35,3}, 
	{35,3}, {35,3}, {35,3}, {35,3}, {35,3}, {51,3}, 
	{51,3}, {51,3}, {51,3}, {51,3}, {51,3}, {51,3}, 
	{51,3},
};

const CH263Dec::VLCtab CH263Dec::m_CBPYtab[48] =
{
	{-1,0}, {-1,0}, {9,6}, {6,6}, {7,5}, {7,5}, {11,5}, {11,5},
	{13,5}, {13,5}, {14,5}, {14,5}, {15,4}, {15,4}, {15,4}, {15,4}, 
	{3,4}, {3,4}, {3,4}, {3,4}, {5,4},{5,4},{5,4},{5,4},
	{1,4}, {1,4}, {1,4}, {1,4}, {10,4}, {10,4}, {10,4}, {10,4},
	{2,4}, {2,4}, {2,4}, {2,4}, {12,4}, {12,4}, {12,4}, {12,4}, 
	{4,4}, {4,4}, {4,4}, {4,4}, {8,4}, {8,4}, {8,4}, {8,4}, 
};


CH263Dec::CH263Dec()
{
	for (int i = 0 ; i < 3 ; i++)
	{
		m_refframe[i] = NULL;
		m_oldrefframe[i] = NULL;
		m_bframe[i] = NULL;
		m_edgeframeorig[i] = NULL;
	}
	m_clp_base = NULL;
	m_clp = NULL;
	m_dlog = NULL;

	Init();
}

CH263Dec::~CH263Dec()
{
	Free();
}

// Get the frame size
bool CH263Dec::GetFrameSize(unsigned char* pH263Bits, unsigned int uiSize)
{
	m_cindex=0;				// index into the cframe....
	m_csize=uiSize;			// size of compressed frame 
	m_cframe=pH263Bits;		// pointer to compressed frme

	// Reset the pointers
	initbits();
	getheader();

	switch (m_source_format) 
	{
		case (SF_SQCIF):
			m_horizontal_size = 128;
			m_vertical_size = 96;
			return true;
		case (SF_QCIF):
			m_horizontal_size = 176;
			m_vertical_size = 144;
			return true;
		case (SF_CIF):
			m_horizontal_size = 352;
			m_vertical_size = 288;
			return true;
		case (SF_4CIF):
			m_horizontal_size = 704;
			m_vertical_size = 576;
			return true;
		case (SF_16CIF):
			m_horizontal_size = 1408;
			m_vertical_size = 1152;
			return true;
		default :
			return false;
	}
}

bool CH263Dec::DecodeH263(CDib* pDib, unsigned char* pH263Bits, unsigned int uiSize)
{
	if (!pDib)
		return false;

	bool bSetBmi = false;

	// We want horizontal_size & vertical_size
	int old_horizontal_size = m_horizontal_size;
	int old_vertical_size = m_vertical_size;
	if (!GetFrameSize(pH263Bits, uiSize))
		return false;
	else
	{
		// If Size Changed
		if (old_horizontal_size != m_horizontal_size ||
			old_vertical_size != m_vertical_size)
		{
			Init();	// Reset Decoder
			GetFrameSize(pH263Bits, uiSize); // Get Again Sizes, because they have been resetted!
		}
	}

	unsigned int uiDecompressedImageSize = DWALIGNEDWIDTHBYTES((unsigned int)m_horizontal_size * 24) * m_vertical_size;

	// Set BMI?
	if (pDib->GetBMIH())
	{
		if (m_horizontal_size != pDib->GetBMIH()->biWidth		||
			m_vertical_size != pDib->GetBMIH()->biHeight		||
			uiDecompressedImageSize != pDib->GetImageSize()	||
			24 != pDib->GetBMIH()->biBitCount				||
			BI_RGB != pDib->GetBMIH()->biCompression)
			bSetBmi = true;
	}
	else
		bSetBmi = true;

	// Do Set BMI
	if (bSetBmi)
	{
		BITMAPINFOHEADER bmiHeader;
		bmiHeader.biSize = sizeof(BITMAPINFOHEADER);
		bmiHeader.biWidth = (unsigned int)m_horizontal_size;
		bmiHeader.biHeight = (unsigned int)m_vertical_size;
		bmiHeader.biPlanes = 1;
		bmiHeader.biBitCount = 24;
		bmiHeader.biCompression = BI_RGB;    
		bmiHeader.biSizeImage = uiDecompressedImageSize;
		bmiHeader.biXPelsPerMeter = 0;
        bmiHeader.biYPelsPerMeter = 0;
		bmiHeader.biClrUsed = 0;
		bmiHeader.biClrImportant = 0;
		pDib->SetBMI((LPBITMAPINFO)&bmiHeader);
	}

	// Make Sure the Bits are allocated
	// (This Function with NULL parameter allocates memory of
	// the necessary size given by the previously set Bmi)
	pDib->SetBits(NULL);

	// Decompress the frame to RGB24
	if (DecompressFrame(	pH263Bits,
							uiSize,
							pDib->GetBits(),
							pDib->GetImageSize(),
							m_nFirst, 
							m_FrameNum) == 1)
		return true;
	else
		return false;
}